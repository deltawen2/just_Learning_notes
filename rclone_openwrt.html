<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>rclone</title>
  <link rel="stylesheet" href="https://stackedit.cn/style.css" />
  <style type="text/css">
    .app--dark {
      background-color: #444;
    }
    .app--dark .stackedit__html {
      padding-left: 0;
      padding-right: 0;
    }
    .app--dark .stackedit__content {
      padding: 1px 20px 20px;
    }
    
  </style>
</head>

<body class="stackedit app--light">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#🧰-openwrt-使用-rclone-掛載-onedrive：完整流程筆記">🧰 OpenWRT 使用 rclone 掛載 OneDrive：完整流程筆記</a>
<ul>
<li><a href="#📦-第一步：安裝-rclone">📦 第一步：安裝 rclone</a></li>
<li><a href="#🔐-第二步：設定-onedrive-remote">🔐 第二步：設定 OneDrive remote</a></li>
<li><a href="#📂-第三步：建立掛載點">📂 第三步：建立掛載點</a></li>
<li><a href="#🧲-第四步：手動掛載-onedrive">🧲 第四步：手動掛載 OneDrive</a></li>
<li><a href="#🔁-第五步：rclone-開機自動掛載完整步驟">🔁 第五步：rclone 開機自動掛載完整步驟</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <div class="stackedit__content preview-theme--default">
        <h1 id="🧰-openwrt-使用-rclone-掛載-onedrive：完整流程筆記"><span class="prefix"></span><span class="content">🧰 OpenWRT 使用 rclone 掛載 OneDrive：完整流程筆記</span><span class="suffix"></span></h1>
<h2 id="📦-第一步：安裝-rclone"><span class="prefix"></span><span class="content">📦 第一步：安裝 rclone</span><span class="suffix"></span></h2>
<pre class=" language-bash"><code class="prism  language-bash">opkg update
opkg <span class="token function">install</span> rclone
</code></pre>
<p>✅ 安裝成功後可用 <code>rclone version</code> 檢查版本</p>
<hr>
<h2 id="🔐-第二步：設定-onedrive-remote"><span class="prefix"></span><span class="content">🔐 第二步：設定 OneDrive remote</span><span class="suffix"></span></h2>
<pre class=" language-bash"><code class="prism  language-bash">rclone config
</code></pre>
<h3 id="設定流程："><span class="prefix"></span><span class="content">設定流程：</span><span class="suffix"></span></h3>
<ol>
<li><code>n</code> → 新增 remote</li>
<li>Remote 名稱：輸入 <code>onedrive</code></li>
<li>選擇雲端類型：輸入 <code>38</code>（OneDrive）</li>
<li>Client ID / Secret：直接按 Enter 跳過</li>
<li>選擇 OneDrive 類型：輸入 <code>1</code>（Global）</li>
<li>tenant：個人帳號直接按 Enter 跳過</li>
<li>授權方式：</li>
</ol>
<pre class=" language-bash"><code class="prism  language-bash">Use web browser to automatically authenticate rclone with remote?
 * Say Y <span class="token keyword">if</span> the machine running rclone has a web browser you can use
 * Say N <span class="token keyword">if</span> running rclone on a <span class="token punctuation">(</span>remote<span class="token punctuation">)</span> machine without web browser access
If not sure try Y. If Y failed, try N.

y<span class="token punctuation">)</span> Yes <span class="token punctuation">(</span>default<span class="token punctuation">)</span>
n<span class="token punctuation">)</span> No
y/n<span class="token operator">&gt;</span> n

Option config_token.
For this to work, you will need rclone available on a machine that has
a web browser available.
For <span class="token function">more</span> <span class="token function">help</span> and alternate methods see: https://rclone.org/remote_setup/
Execute the following on the machine with the web browser <span class="token punctuation">(</span>same rclone
version recommended<span class="token punctuation">)</span>:
	rclone authorize <span class="token string">"onedrive"</span>
Then <span class="token function">paste</span> the result.
Enter a value.

</code></pre>
<pre><code> 在電腦上執行：
 rclone authorize "onedrive"
    
        
   登入 OneDrive 並複製 token（包含 `{}`）
   回到 OpenWRT 貼上 token
</code></pre>
<ol start="8">
<li><code>y</code> → 儲存設定</li>
<li><code>q</code> → 離開設定</li>
</ol>
<p>✅ 完成後可用 <code>rclone ls onedrive:/</code> 測試連線</p>
<hr>
<h2 id="📂-第三步：建立掛載點"><span class="prefix"></span><span class="content">📂 第三步：建立掛載點</span><span class="suffix"></span></h2>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token function">mkdir</span> -p /mnt/onedrive
</code></pre>
<hr>
<h2 id="🧲-第四步：手動掛載-onedrive"><span class="prefix"></span><span class="content">🧲 第四步：手動掛載 OneDrive</span><span class="suffix"></span></h2>
<pre class=" language-bash"><code class="prism  language-bash">rclone <span class="token function">mount</span> onedrive:/ /mnt/onedrive \
  --copy-links \
  --allow-other \
  --allow-non-empty \
  --umask 000 \
  --daemon
</code></pre>
<p>✅ 用 <code>df -h</code> 或 <code>ls /mnt/onedrive</code> 檢查是否掛載成功</p>
<hr>
<h2 id="🔁-第五步：rclone-開機自動掛載完整步驟"><span class="prefix"></span><span class="content">🔁 第五步：rclone 開機自動掛載完整步驟</span><span class="suffix"></span></h2>
<p>本筆記將詳細記錄如何讓 <code>rclone</code> 服務在 OpenWrt <strong>開機完成後</strong> 自動掛載雲端硬碟 (以 OneDrive 為例)。</p>
<h3 id="最終診斷：為什麼之前失敗？"><span class="prefix"></span><span class="content">最終診斷：為什麼之前失敗？</span><span class="suffix"></span></h3>
<ul>
<li>
<p><strong>問題：</strong> OpenWrt 的網路服務需要時間啟動。傳統的 <code>/etc/init.d/</code> 服務腳本在網路就緒前就開始運行 <code>rclone mount</code>，導致連線失敗。</p>
</li>
<li>
<p><strong>解決方案：</strong> 使用 <strong><code>/etc/rc.local</code></strong> (開機結束後才執行的腳本)，並在命令中加入 <strong>延遲 (<code>sleep</code>)</strong> 和 <strong>背景執行 (<code>&amp;</code>)</strong>，確保 <code>rclone</code> 在網路穩定後才開始嘗試連線。</p>
</li>
</ul>
<hr>
<h3 id="步驟-1：清理舊的啟動服務-避免衝突"><span class="prefix"></span><span class="content">步驟 1：清理舊的啟動服務 (避免衝突)</span><span class="suffix"></span></h3>
<p>如果您曾嘗試使用 <code>/etc/init.d/rcloned</code> 腳本，請先將其移除，以防衝突：</p>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment"># 1. 禁用服務</span>
/etc/init.d/rcloned disable

<span class="token comment"># 2. 刪除服務腳本和啟動連結</span>
<span class="token function">rm</span> -f /etc/init.d/rcloned
<span class="token function">rm</span> -f /etc/rc.d/S99rcloned
<span class="token function">rm</span> -f /etc/rc.d/K10rcloned
</code></pre>
<h3 id="步驟-3：修改-etcrc.local-腳本-核心步驟"><span class="prefix"></span><span class="content">步驟 3：修改 <code>/etc/rc.local</code> 腳本 (核心步驟)</span><span class="suffix"></span></h3>
<p>使用 <code>nano</code> 或 <code>vi</code> 編輯 <code>/etc/rc.local</code> 檔案。您需要將以下程式碼塊放在 <strong><code>exit 0</code></strong> 這一行之前。</p>
<pre class=" language-bash"><code class="prism  language-bash">root@OpenWrt:~<span class="token comment"># nano /etc/rc.local</span>
</code></pre>
<h4 id="✍️-貼上以下內容（放在-exit-0-前）："><span class="prefix"></span><span class="content">✍️ 貼上以下內容（放在 <code>exit 0</code> 前）：</span><span class="suffix"></span></h4>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token comment"># Put your custom commands here that should be executed once</span>
<span class="token comment"># the system init finished. By default this file does nothing.</span>

<span class="token comment"># --- rclone mount 邏輯 (開機完成後執行) ---</span>

<span class="token punctuation">(</span>
    <span class="token comment"># 確保 rclone 相關的檔案是新的</span>
    <span class="token function">rm</span> -f /tmp/rclone_rc_local.log
    <span class="token function">rm</span> -f /tmp/rclone_mount.log
    <span class="token keyword">echo</span> <span class="token string">"Starting rclone mount via rc.local at <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span><span class="token variable">)</span></span>"</span> <span class="token operator">&gt;</span> /tmp/rclone_rc_local.log
    
    <span class="token comment"># 關鍵：延遲 15 秒，確保網路完全穩定</span>
    <span class="token function">sleep</span> 15
    
    MOUNTPOINT<span class="token operator">=</span><span class="token string">"/mnt/onedrive"</span>
    CONFIG_PATH<span class="token operator">=</span><span class="token string">"/root/.config/rclone/rclone.conf"</span> 
    REMOTE<span class="token operator">=</span><span class="token string">"onedrive:/"</span>
    RCLONE_LOG<span class="token operator">=</span><span class="token string">"/tmp/rclone_mount.log"</span> 
    
    <span class="token comment"># 建立掛載點 (若不存在)</span>
    <span class="token punctuation">[</span> -d <span class="token string">"<span class="token variable">$MOUNTPOINT</span>"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">mkdir</span> -p <span class="token string">"<span class="token variable">$MOUNTPOINT</span>"</span>
    
    <span class="token comment"># 執行掛載命令</span>
    /usr/bin/rclone <span class="token function">mount</span> <span class="token string">"<span class="token variable">$REMOTE</span>"</span> <span class="token string">"<span class="token variable">$MOUNTPOINT</span>"</span> \
      --config <span class="token string">"<span class="token variable">$CONFIG_PATH</span>"</span> \
      --copy-links \
      --allow-other \
      --allow-non-empty \
      --umask 000 \
      --log-file <span class="token string">"<span class="token variable">$RCLONE_LOG</span>"</span> \
      --log-level INFO \
      --retries 5 \
      --low-level-retries 10 \
      --stats 1m \
      --daemon

    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">"rclone mount command initiated successfully."</span> <span class="token operator">&gt;&gt;</span> /tmp/rclone_rc_local.log
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">"rclone mount command failed to initiate."</span> <span class="token operator">&gt;&gt;</span> /tmp/rclone_rc_local.log
    <span class="token keyword">fi</span>
<span class="token punctuation">)</span> <span class="token operator">&amp;</span>  <span class="token comment"># &lt;-- 關鍵：使用 ( ... ) &amp; 確保整個區塊在背景執行</span>

<span class="token comment"># --- 結束 rclone 邏輯 ---</span>

<span class="token keyword">exit</span> 0
</code></pre>
<h3 id="步驟-4：最終測試"><span class="prefix"></span><span class="content">步驟 4：最終測試</span><span class="suffix"></span></h3>
<p>儲存並退出 <code>/etc/rc.local</code> 檔案後，執行重啟命令：</p>
<p>Bash</p>
<pre><code>root@OpenWrt:~# reboot
</code></pre>
<p>登入 OpenWrt 後，<strong>請等待約 30 秒</strong> (給予腳本執行和 <code>rclone</code> 啟動緩衝時間)，然後執行以下命令確認：</p>
<pre class=" language-bash"><code class="prism  language-bash">root@OpenWrt:~<span class="token comment"># df -h</span>
</code></pre>
<p><strong>✅ 預期結果：</strong></p>
<p>您應該會在輸出列表中看到 <code>onedrive:</code> 掛載點，證明自動啟動已成功！</p>
<pre class=" language-bash"><code class="prism  language-bash">onedrive:                       5.0G      8.0K      5.0G    0% /mnt/onedrive
</code></pre>

      </div>
    </div>
  </div>
</body>

</html>
