<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>uhttpad_openwrt架站</title>
  <link rel="stylesheet" href="https://stackedit.cn/style.css" />
  <style type="text/css">
    .app--dark {
      background-color: #444;
    }
    .app--dark .stackedit__html {
      padding-left: 0;
      padding-right: 0;
    }
    .app--dark .stackedit__content {
      padding: 1px 20px 20px;
    }
    
  </style>
</head>

<body class="stackedit app--dark">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#openwrt--uhttpd-openssh架設網站＆個人雲端">OpenWrt + uHTTPd +openSSH架設網站＆個人雲端</a>
<ul>
<li><a href="#設定固定ip">設定固定IP</a></li>
<li><a href="#🛠-安裝-uhttpd">🛠 安裝 uHTTPd</a></li>
<li><a href="#🔧-設定-uhttpd-網站根目錄與-port">🔧 設定 uHTTPd 網站根目錄與 port</a></li>
<li><a href="#增加防火牆規則">增加防火牆規則</a></li>
<li><a href="#設定首頁">設定首頁</a></li>
<li><a href="#🌐-測試外部訪問">🌐 測試外部訪問</a></li>
</ul>
</li>
<li><a href="#🌐追加提供上傳下載（個人雲端）">🌐追加提供上傳下載（個人雲端）</a>
<ul>
<li><a href="#🔧設定openssh">🔧設定openSSH</a></li>
</ul>
</li>
<li><a href="#增加互動式上傳界面">增加互動式上傳界面</a>
<ul>
<li><a href="#建制後端驗證處理程序">建制後端驗證處理程序</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <div class="stackedit__content preview-theme--default">
        <h1 id="openwrt--uhttpd-openssh架設網站＆個人雲端"><span class="prefix"></span><span class="content">OpenWrt + uHTTPd +openSSH架設網站＆個人雲端</span><span class="suffix"></span></h1>
<p>邊界條件</p>
<blockquote>
<p>固定IP<br>
一台12年前的x86電腦<br>
<a href="https://deltawen2.github.io/just_Learning_notes/openwrt_live_usb.html">OpenWrt略知一二</a></p>
</blockquote>
<h2 id="設定固定ip"><span class="prefix"></span><span class="content">設定固定IP</span><span class="suffix"></span></h2>
<p>從ISP業者(網際網路服務供應商)取得固定IP<br>
這裡以中華電信pppoe為例<br>
寫進/etc/config/network</p>
<pre class=" language-bash"><code class="prism  language-bash">config interface <span class="token string">'wan'</span>
	option device <span class="token string">'eth1'</span>
	option proto <span class="token string">'pppoe'</span>
	option username <span class="token string">'********@ip.hinet.net'</span>
	option password <span class="token string">'******************'</span>
	option ipv6 <span class="token string">'auto'</span>
</code></pre>
<h2 id="🛠-安裝-uhttpd"><span class="prefix"></span><span class="content">🛠 安裝 uHTTPd</span><span class="suffix"></span></h2>
<pre class=" language-bash"><code class="prism  language-bash">opkg update
opkg <span class="token function">install</span> uhttpd uhttpd-mod-ubus
</code></pre>
<h2 id="🔧-設定-uhttpd-網站根目錄與-port"><span class="prefix"></span><span class="content">🔧 設定 uHTTPd 網站根目錄與 port</span><span class="suffix"></span></h2>
<pre class=" language-bash"><code class="prism  language-bash">uci <span class="token keyword">set</span> uhttpd.main.listen_http<span class="token operator">=</span><span class="token string">'0.0.0.0:80'</span>
uci <span class="token keyword">set</span> uhttpd.main.listen_https<span class="token operator">=</span><span class="token string">'0.0.0.0:443'</span>
uci <span class="token keyword">set</span> uhttpd.main.home<span class="token operator">=</span><span class="token string">'/www'</span>
uci commit uhttpd
/etc/init.d/uhttpd restart
</code></pre>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment">#透過增加 script_timeout 成600秒 和 network_timeout 成300秒避免上傳時間過久而自動中止</span>
<span class="token function">vi</span> /etc/config/uhttpd
</code></pre>
<pre class=" language-bash"><code class="prism  language-bash">option cgi_prefix <span class="token string">'/cgi-bin'</span>
list lua_prefix <span class="token string">'/cgi-bin/luci=/usr/lib/lua/luci/sgi/uhttpd.lua'</span>
option script_timeout <span class="token string">'600'</span>
option network_timeout <span class="token string">'300'</span>
option http_keepalive <span class="token string">'20'</span>
option tcp_keepalive <span class="token string">'1'</span>
option ubus_prefix <span class="token string">'/ubus'</span>
</code></pre>
<h2 id="增加防火牆規則"><span class="prefix"></span><span class="content">增加防火牆規則</span><span class="suffix"></span></h2>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment"># 開放 port 80 (HTTP)</span>
uci add firewall rule
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.name<span class="token operator">=</span><span class="token string">'Allow-HTTP'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.src<span class="token operator">=</span><span class="token string">'wan'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.proto<span class="token operator">=</span><span class="token string">'tcp'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.dest_port<span class="token operator">=</span><span class="token string">'80'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.target<span class="token operator">=</span><span class="token string">'ACCEPT'</span>

<span class="token comment"># 開放 port 443 (HTTPS) 可選</span>
uci add firewall rule
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.name<span class="token operator">=</span><span class="token string">'Allow-HTTPS'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.src<span class="token operator">=</span><span class="token string">'wan'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.proto<span class="token operator">=</span><span class="token string">'tcp'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.dest_port<span class="token operator">=</span><span class="token string">'443'</span>
uci <span class="token keyword">set</span> firewall.@rule<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.target<span class="token operator">=</span><span class="token string">'ACCEPT'</span>

uci commit firewall
/etc/init.d/firewall restart
</code></pre>
<h2 id="設定首頁"><span class="prefix"></span><span class="content">設定首頁</span><span class="suffix"></span></h2>
<p>建立首頁index.html放在/www/下<br>
確保 <code>/www/index.html</code> 存在或放置你要提供的網頁內容。</p>
<pre class=" language-html"><code class="prism  language-html"><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zh-TW<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>歡迎來到我的 OpenWrt_coarse fish 網頁<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
        <span class="token selector">body </span><span class="token punctuation">{</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token hexcode">#f0f0f0</span><span class="token punctuation">;</span>
            <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"Segoe UI"</span>, <span class="token string">"Noto Sans TC"</span>, sans-serif<span class="token punctuation">;</span>
            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
            <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">50</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">h1 </span><span class="token punctuation">{</span>
            <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#2c3e50</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">p </span><span class="token punctuation">{</span>
            <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#555</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector"><span class="token class">.ip-box</span> </span><span class="token punctuation">{</span>
            <span class="token property">margin-top</span><span class="token punctuation">:</span> <span class="token number">30</span>px<span class="token punctuation">;</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token hexcode">#fff</span><span class="token punctuation">;</span>
            <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">20</span>px<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">8</span>px<span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
            <span class="token property">box-shadow</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">10</span>px <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span>,<span class="token number">0</span>,<span class="token number">0</span>,<span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>🎉 OpenWrt_一頭雜魚的海洋 網站架設成功！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>您正在使用 uHTTPd 提供網頁服務<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ip-box<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>LAN IP：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>甘你屁事<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>Public IP：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> 1.34.212.93<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>固定對端 IP：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>甘你屁事<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>檔案上傳<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/cgi-bin/upload.sh<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>使用者名稱：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>密碼：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fileToUpload<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>選擇檔案：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fileToUpload<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fileToUpload<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>上傳檔案<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>請注意，<code>form</code> 標籤中的 <code>action="/cgi-bin/upload.sh"</code> 假設您的後端處理腳本會放在 <code>/www/cgi-bin/</code> 目錄下，且檔名為 <code>upload.sh</code></p>
<h2 id="🌐-測試外部訪問"><span class="prefix"></span><span class="content">🌐 測試外部訪問</span><span class="suffix"></span></h2>
<p>http:// ISP業者提供的IP/</p>
<h1 id="🌐追加提供上傳下載（個人雲端）"><span class="prefix"></span><span class="content">🌐追加提供上傳下載（個人雲端）</span><span class="suffix"></span></h1>
<h2 id="🔧設定openssh"><span class="prefix"></span><span class="content">🔧設定openSSH</span><span class="suffix"></span></h2>
<blockquote>
<p><a href="https://deltawen2.github.io/just_Learning_notes/openwrt_OpenSSH.html">https://deltawen2.github.io/just_Learning_notes/openwrt_OpenSSH.html</a></p>
</blockquote>
<h1 id="增加互動式上傳界面"><span class="prefix"></span><span class="content">增加互動式上傳界面</span><span class="suffix"></span></h1>
<h2 id="建制後端驗證處理程序"><span class="prefix"></span><span class="content">建制後端驗證處理程序</span><span class="suffix"></span></h2>
<p>整個方案將由兩個檔案組成</p>
<ol>
<li><strong><code>upload.sh</code> (CGI Wrapper)</strong>：一個非常簡單的 Shell 腳本，用來啟動 Python 腳本並設定環境。</li>
</ol>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment">#創建/www/cgi-bin/upload.sh</span>
<span class="token function">vi</span> /www/cgi-bin/upload.sh
</code></pre>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token shebang important">#!/bin/sh</span>

<span class="token comment"># 導向標準輸入 (stdin) 和環境變數給 Python 腳本</span>
<span class="token comment"># uHTTPd 會將 POST 資料透過 stdin 傳入</span>
/usr/bin/python3 /www/cgi-bin/upload.py
</code></pre>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment">#設定執行權限</span>
<span class="token function">chmod</span> +x /www/cgi-bin/upload.sh
</code></pre>
<ol start="2">
<li><strong><code>upload.py</code> (主要邏輯)</strong>：一個功能完整的 Python 腳本，負責處理上傳、驗證和儲存檔案。</li>
</ol>
<p>確保您的 OpenWrt 系統已安裝 Python 3</p>
<pre class=" language-bash"><code class="prism  language-bash">opkg update <span class="token operator">&amp;&amp;</span> opkg <span class="token function">install</span> python3
</code></pre>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment">#創建/www/cgi-bin/upload.py</span>
<span class="token function">vi</span> /www/cgi-bin/upload.py
</code></pre>
<pre class=" language-py"><code class="prism  language-py"><span class="token comment">#!/usr/bin/env python3</span>

<span class="token comment"># 導入必要的模組</span>
<span class="token keyword">import</span> cgi
<span class="token keyword">import</span> cgitb
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os
<span class="token keyword">import</span> crypt <span class="token comment"># 用於驗證系統使用者密碼</span>
<span class="token keyword">import</span> datetime <span class="token comment"># 導入 datetime 模組來處理時間</span>

<span class="token comment"># 啟用詳細的錯誤報告，方便除錯。</span>
<span class="token comment"># 在生產環境中，建議禁用此功能，以避免洩露敏感資訊。</span>
cgitb<span class="token punctuation">.</span>enable<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 檔案上傳的目標目錄。</span>
<span class="token comment"># !!! 警告：請務必將此路徑修改為非網頁公開的目錄，以確保安全。</span>
<span class="token comment"># 例如：/root/uploads/ 或 /mnt/sda1/uploads/</span>
UPLOAD_DIR <span class="token operator">=</span> <span class="token string">"/www/uploads/"</span> <span class="token comment"># 您目前設定的路徑。再次強烈建議修改為 /root/uploads/</span>

<span class="token comment"># 確保上傳目錄存在</span>
<span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>UPLOAD_DIR<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>UPLOAD_DIR<span class="token punctuation">)</span>
    <span class="token keyword">except</span> OSError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 如果創建目錄失敗，則印出錯誤並退出</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Content-type: text/html; charset=UTF-8\n"</span><span class="token punctuation">)</span> <span class="token comment"># 修正：加上 charset=UTF-8</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=\"UTF-8\"&gt;&lt;title&gt;錯誤&lt;/title&gt;&lt;/head&gt;&lt;body&gt;"</span><span class="token punctuation">)</span> <span class="token comment"># 修正：加上 &lt;meta charset="UTF-8"&gt;</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"&lt;h3&gt;❌ 伺服器錯誤&lt;/h3&gt;"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"&lt;p&gt;無法建立上傳目錄：{UPLOAD_DIR}。請檢查權限或路徑。錯誤訊息：{e}&lt;/p&gt;"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;/body&gt;&lt;/html&gt;"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 退出腳本</span>

<span class="token comment"># 函式：驗證使用者帳號和密碼</span>
<span class="token keyword">def</span> <span class="token function">authenticate_user</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    使用系統的 /etc/shadow 檔案來驗證使用者密碼。
    警告：直接讀取 /etc/shadow 檔案需要腳本有足夠的權限，這可能存在安全風險。
    在更安全的生產環境中，建議使用 PAM 模組或更底層的系統驗證 API。
    """</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> username <span class="token operator">or</span> <span class="token operator">not</span> password<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span> <span class="token comment"># 使用者名稱或密碼不能為空</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/etc/shadow"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> shadow_file<span class="token punctuation">:</span>
            <span class="token keyword">for</span> line <span class="token keyword">in</span> shadow_file<span class="token punctuation">:</span>
                parts <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> username<span class="token punctuation">:</span>
                    <span class="token comment"># 取得雜湊密碼 (hashed password)</span>
                    hashed_password <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                    <span class="token comment"># 使用 crypt 模組驗證密碼</span>
                    <span class="token keyword">return</span> crypt<span class="token punctuation">.</span>crypt<span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashed_password<span class="token punctuation">)</span> <span class="token operator">==</span> hashed_password
    <span class="token keyword">except</span> IOError<span class="token punctuation">:</span>
        <span class="token comment"># 如果無法讀取 /etc/shadow 檔案，則驗證失敗（例如權限不足）</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"Error: Cannot read /etc/shadow. Check script permissions.\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span>f<span class="token string">"Error during authentication: {e}\n"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span> <span class="token comment"># 如果找不到使用者名稱</span>

<span class="token comment"># 函式：主程式邏輯</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 設定 HTTP 回應的 Content-type 為 HTML，並明確指定 UTF-8 編碼</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Content-type: text/html; charset=UTF-8\n"</span><span class="token punctuation">)</span> <span class="token comment"># 修正：加上 charset=UTF-8</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=\"UTF-8\"&gt;&lt;title&gt;檔案上傳結果&lt;/title&gt;&lt;/head&gt;&lt;body&gt;"</span><span class="token punctuation">)</span> <span class="token comment"># 修正：加上 &lt;meta charset="UTF-8"&gt;</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 建立 FieldStorage 物件來解析表單資料 (POST 請求的內容)</span>
        form <span class="token operator">=</span> cgi<span class="token punctuation">.</span>FieldStorage<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 取得使用者名稱和密碼欄位的值</span>
        username <span class="token operator">=</span> form<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
        password <span class="token operator">=</span> form<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>

        <span class="token comment"># 檢查帳號密碼是否正確</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> authenticate_user<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;h3&gt;❌ 登入失敗&lt;/h3&gt;"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;p&gt;使用者名稱或密碼不正確。&lt;/p&gt;"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;/body&gt;&lt;/html&gt;"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token comment"># 驗證失敗，直接結束腳本</span>

        <span class="token comment"># 處理檔案上傳</span>
        <span class="token comment"># 檢查 'fileToUpload' 欄位是否存在且是檔案類型</span>
        <span class="token keyword">if</span> <span class="token string">'fileToUpload'</span> <span class="token keyword">in</span> form <span class="token operator">and</span> form<span class="token punctuation">[</span><span class="token string">'fileToUpload'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>filename<span class="token punctuation">:</span>
            file_item <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">'fileToUpload'</span><span class="token punctuation">]</span>
            
            <span class="token comment"># 取得原始檔名，並確保只取檔名部分，避免路徑遍歷攻擊</span>
            <span class="token comment"># 這裡需要注意，如果檔名本身包含非 ASCII 字元，</span>
            <span class="token comment"># file_item.filename 可能已經是 UTF-8 編碼的位元組串，</span>
            <span class="token comment"># 但 os.path.basename 通常能正確處理。</span>
            file_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file_item<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
            <span class="token comment"># 建立檔案的完整儲存路徑</span>
            file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>UPLOAD_DIR<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

            <span class="token comment"># 檢查檔案是否已經存在，如果存在可以考慮重新命名或提示</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;h3&gt;⚠️ 警告&lt;/h3&gt;"</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"&lt;p&gt;檔案 **{file_name}** 已存在，將會覆蓋。&lt;/p&gt;"</span><span class="token punctuation">)</span>
                <span class="token comment"># 如果不希望覆蓋，可以在這裡修改檔名，例如加上時間戳</span>
                <span class="token comment"># import time</span>
                <span class="token comment"># file_name = f"{os.path.splitext(file_name)[0]}_{int(time.time())}{os.path.splitext(file_name)[1]}"</span>
                <span class="token comment"># file_path = os.path.join(UPLOAD_DIR, file_name)</span>

            <span class="token comment"># 記錄上傳開始時間</span>
            start_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 將檔案內容寫入到指定路徑</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> output_file<span class="token punctuation">:</span>
                <span class="token comment"># 逐塊讀取上傳的檔案內容並寫入，以處理大檔案</span>
                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    chunk <span class="token operator">=</span> file_item<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment"># 每次讀取 10KB</span>
                    <span class="token keyword">if</span> <span class="token operator">not</span> chunk<span class="token punctuation">:</span>
                        <span class="token keyword">break</span>
                    output_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
            
            <span class="token comment"># 記錄上傳結束時間</span>
            end_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 計算上傳時間</span>
            upload_duration <span class="token operator">=</span> end_time <span class="token operator">-</span> start_time
            <span class="token comment"># 取得檔案大小</span>
            file_size_bytes <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>

            <span class="token comment"># 將檔案大小轉換為更易讀的格式 (KB, MB, GB)</span>
            <span class="token keyword">def</span> <span class="token function">format_bytes</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 格式化檔案大小的輔助函數</span>
                power <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">10</span>
                n <span class="token operator">=</span> <span class="token number">0</span>
                byte_labels <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span> <span class="token punctuation">:</span> <span class="token string">'Bytes'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'KB'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'MB'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'GB'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">'TB'</span><span class="token punctuation">}</span>
                <span class="token keyword">while</span> size <span class="token operator">&gt;</span> power<span class="token punctuation">:</span>
                    size <span class="token operator">/=</span> power
                    n <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">return</span> f<span class="token string">"{size:.2f} {byte_labels[n]}"</span>

            formatted_file_size <span class="token operator">=</span> format_bytes<span class="token punctuation">(</span>file_size_bytes<span class="token punctuation">)</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;h3&gt;✅ 上傳成功！&lt;/h3&gt;"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"&lt;p&gt;檔案 **{file_name}** 已成功上傳到！&lt;/p&gt;"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"&lt;p&gt;檔案大小：{formatted_file_size}&lt;/p&gt;"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"&lt;p&gt;上傳時間：{upload_duration.total_seconds():.2f} 秒&lt;/p&gt;"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;h3&gt;⚠️ 警告&lt;/h3&gt;"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;p&gt;沒有選擇檔案或上傳失敗。&lt;/p&gt;"</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 捕獲所有未預期的錯誤，並印出錯誤訊息</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;h3&gt;❌ 發生錯誤&lt;/h3&gt;"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"&lt;p&gt;處理上傳時發生未預期的錯誤：{e}&lt;/p&gt;"</span><span class="token punctuation">)</span>
        <span class="token comment"># 為了除錯，也可以印出詳細的 traceback</span>
        <span class="token comment"># import traceback</span>
        <span class="token comment"># print("&lt;pre&gt;")</span>
        <span class="token comment"># print(traceback.format_exc())</span>
        <span class="token comment"># print("&lt;/pre&gt;")</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&lt;/body&gt;&lt;/html&gt;"</span><span class="token punctuation">)</span>

<span class="token comment"># 確保腳本被直接執行時才呼叫 main 函式</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token comment">#設定執行權限</span>
<span class="token function">chmod</span> +x /www/cgi-bin/upload.py
</code></pre>

      </div>
    </div>
  </div>
</body>

</html>
